# Component Palette Expansion Plan

Phase 3 requires components that make LLM-authored screens feel distinct from the rules baseline. This plan outlines the additional field kinds, schema updates, renderer work, and prompt guidance needed to support AI-only UI elements safely.

## Goals
- Introduce visually obvious, low-risk components the LLM can deploy.
- Keep runtime validators and fallback logic intact by whitelisting all new kinds.
- Provide deterministic renderers so design can predict the layout.
- Allow telemetry to differentiate AI-driven components.

## Current Constraints Recap
- Allowed kinds: `text`, `select`, `radio`, `checkbox`.
- `Field` union in `src/lib/types/form.ts` only supports inputs.
- `repairLLMPayload` coerces unsupported kinds to `text`.
- Form renderer expects every field to collect data; no display-only blocks.

## Proposed Component Palette

| Kind | Persona Bias | Description | Data Binding | Notes |
| ---- | ------------ | ----------- | ------------ | ----- |
| `callout` | Explorer | Display-only banner with icon + body copy (success/info/warning). | None | Highlights reassurance or success tips. Skipped in submission payload. |
| `checklist` | Explorer | Read-only bullet list of next steps with optional check icons. | None | Accepts `items: { id, label, helperText? }[]`. |
| `info_badge` | Team | Inline badge with pill styling for extra context (e.g. "SAML ready"). | None | Moves to meta region near field groups. |
| `integration_picker` | Team | Multi-select pre-populated with top SaaS integrations. | Values array | Maps to `checkbox` under the hood for storage, but uses dedicated renderer to show logos. |
| `teammate_invite` | Team | Stackable email inputs + role select for inviting members. | Values array of `{ email, role }` | Serializes to array and validates format. |
| `admin_toggle` | Power | Ternary toggle (Enable, Disable, Learn more). | Single value | Renders as segmented control. |
| `ai_hint` | Any | Small italicized hint generated by LLM about why a field matters. | None | Attached to preceding field via `targetFieldId`. |

## Schema & Type Updates
1. Extend `src/lib/types/form.ts` with new discriminated unions:
   - `CalloutField`, `ChecklistField`, `InfoBadgeField` (display-only) with `kind` property and optional variant enums.
   - `IntegrationPickerField` extends checkbox semantics with `options`, `iconKey`.
   - `TeammateInviteField` typed as complex object requiring dedicated form logic.
   - `AdminToggleField` behaves like `radio` with 3 options but simplified config.
2. Update helper functions (`getFieldValue`, type guards) to cover new kinds or explicitly skip display-only in submission payloads.
3. Adjust `FormRenderer` to branch on display kinds before the form grid (render using new components in `components/form/fields/`).

## Validation & Repair Logic
- Update `FIELD_IDS` to include new value IDs (`integration_list`, `team_invites`, `admin_controls`, etc.).
- Teach `repairLLMPayload` to map aliases: `multi_select` → `integration_picker`; `banner` → `callout`; `toggles` → `admin_toggle`.
- Ensure display-only components are stripped from value submission to API.
- Add schema validation (Zod) in `src/lib/policy/response-parser.ts` so new kinds are accepted with required properties.

## Rendering Plan
- Create dedicated components under `src/components/form/experimental/`:
  - `Callout`, `Checklist`, `InfoBadge`, `IntegrationPicker`, `TeammateInvite`, `AdminToggle`, `AIHint`.
- Wrap experimental components behind feature flag `ENABLE_EXPERIMENTAL_COMPONENTS` (defaults true for dev).
- Fallback: if flag off or renderer missing, degrade gracefully to text/checkbox and log warning.

## Prompt Updates
- Add examples for each component kind to `SYSTEM_PROMPTS.FORM_ORCHESTRATOR`, including when to choose them.
- Provide guardrails: max 1 callout per step, no more than 3 checklist items, teammate invite only for persona `team`.
- Document in `docs/prompt-changelog.md` (to be created).

## Telemetry & Eval
- Emit `component_kind` and `is_ai_component` when LLM response includes new kinds.
- Eval logger to compute `ai_component_count` metric.
- Add screenshot fixtures demonstrating Explorer vs Team palettes.
- Canvas Chat emits `canvas_plan_rendered` telemetry events capturing recipe, persona, confidence, decision source, and component counts, and logs matching records to `eval/logs/canvas/*.jsonl` for downstream analysis.

## Implementation Checklist
1. Update constants (`FIELD_IDS`, `FIELD_ID_SET`) and create mappings for new ids.
2. Extend type definitions and Zod schema for `propose_next_step` payloads.
3. Build React components + storybook-like mdx for design signoff.
4. Update `FormRenderer` to support display components and complex inputs.
5. Expand `repairLLMPayload` tests to cover new aliases and validation.
6. Revise prompts and add persona-specific examples referencing new components.
7. Capture fixtures under `eval/snapshots/` for regression tests.
8. Update README + Phase docs once feature flag ready.

## Open Questions
- Should `teammate_invite` enforce unique emails client-side or rely on backend? (lean client-side warning only).
- Do we need accessibility copy for callouts (aria-live)? consult design.
- What’s the fallback when LLM outputs unsupported icons/logos for integrations? Possibly map to known set.

---
**Next Actions**
- Review palette with design to confirm visual treatments.
- Align engineering on serialization format for complex fields.
- Begin implementation with constants/types updates gated behind feature flag.
